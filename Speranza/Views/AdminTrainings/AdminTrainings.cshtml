@model Speranza.Models.AdminTrainingsModel
@{
    ViewBag.Title = "Správa tréningov";
    Layout = "~/Views/Layout.cshtml";
}
<div class="container">
    <h2>
        Správa tréningov
        <button id="AddNewTraining" class="btn btn-warning"><span class="glyphicon glyphicon-plus"></span></button>
    </h2>
    
    <div id="messageBox" style="display:none;" class="alert alert-success" role="alert"></div>
    <div id="messageBoxWarning" style="display:none;" class="alert alert-warning" role="alert"></div>

    <table class="table table-striped table-hover" id="TrainingsTable">
        <thead>
            <tr>
                <th class="col-xs-1">Dátum</th>
                <th class="col-xs-1">Čas</th>
                <th class="col-xs-3">Popis</th>
                <th class="col-xs-2">Tréner</th>
                <th class="col-xs-1">Prihlásení</th>
                <th class="col-xs-1">Kapacita</th>
                <th>Akcia</th>
            </tr>
        </thead>
        @foreach (var item in Model.Trainings.OrderBy(s => s.Time))
        {
            <tr id="@item.ID-Row">
                <td id="@item.ID-date">@item.Time.ToString("dd.MM.yyyy")</td>
                <td id="@item.ID-time">@item.Time.ToString("HH:mm")</td>
                <td><textarea  class="trainingDescription form-control input-sm" rows="1" data-training="@item.ID">@item.Description</textarea></td>
                <td><input type="text" value="@item.Trainer" class="trainingTrainer form-control input-sm" data-training="@item.ID"/></td>
                <td>
               <span id="@item.ID-RegisteredNumber">@item.RegisteredNumber</span> 
                <span class="label label-info TrainingDetails" style="cursor:pointer" data-training="@item.ID">Detail</span>
                </td>
                <td><input id="TrainingCapacity" type="number" value="@item.Capacity" min="@item.Capacity" class="trainingCapacity form-control input-sm " data-training="@item.ID"/></td>
                <td><a class="CancelTraining" data-training="@item.ID" href="#">Zrušiť tréning</a></td>
            </tr>
        }
    </table>
</div>

@*Modal window with All users sign up in training*@
<div class="modal fade" id="trainingDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Prihlásení na tréning <span id="modalTitleTraining"></span></h4>
            </div>
            <div class="modal-body" id="TrainingDetailsBody">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Zatvoriť</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


@*New training modal window*@
    <div class="modal fade" id="NewTraining" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Vytvoriť nový tréning</h4>
                </div>
                <div class="modal-body form-horizontal">
                    <div id="messageBoxNewTraining" style="display:none;" class="alert alert-warning" role="alert"></div>
                    @*Training date*@
                    <div class="form-group">
                        @Html.Label("Dátum", new { @class = "control-label col-sm-3" })
                        <div class="input-group date col-sm-4">
                            <input id="TrainingDate" type="text" class="form-control"><span id="trainingDateButton" class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                        </div>
                    </div>

                    @*Training time*@
                    <div class="form-group">
                        @Html.Label("Čas", new { @class = "control-label col-sm-3" })
                        <div class="input-group col-sm-4">
                            <input id="TrainingTime" data-format="hh:mm" type="text" class="form-control" />
                            <span class="input-group-addon" id="trainingTimeButton">
                                <i class="glyphicon glyphicon-time">
                                </i>
                            </span>
                        </div>
                    </div>

                    @*Training trainer*@
                    <div class="form-group">
                        @Html.Label("Tréner", new { @class = "control-label col-sm-3", @for = "Trainer" })
                        <div class="col-sm-6 input-group">
                            @Html.TextBox("Trainer", "", new { @class = "form-control", id = "NewTrainingTrainer" })
                        </div>
                    </div>

                    @*Training Description*@
                    <div class="form-group">
                        @Html.Label("Popis", new { @class = "control-label col-sm-3", @for = "Description" })
                        <div class="col-sm-6 input-group">
                            @Html.TextArea("Description", "", new { @class = "form-control", id = "NewTrainingDescription" })
                        </div>
                    </div>

                    @*Training Capacity*@
                    <div class="form-group">
                        @Html.Label("Kapacita", new { @class = "control-label col-sm-3", @for = "Capacity" })
                        <div class="col-sm-6 input-group">
                            <input type="number" name="Capacity" min="1" class="form-control" id="NewTrainingCapacity">
                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    @*SaveButton*@
                    <button id="CreateTrainingButton" type="submit" class="btn btn-default">Vytvoriť</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Zrušiť</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

@section scripts {
    <script>
        $("#TrainingsTable").on("change", ".trainingDescription", function (event) {
            TrainingDescription($(this));
        });

      function TrainingDescription(element){
                var trainingID = element.data('training');
                //value z textboxu
                var value = element.prop('value');
                $.ajax({
                    url: "ChangeTrainingDescription",
                    data: { trainingID: trainingID, description: value },
                    type: 'POST',
                    dataType: "json",
                    success: function (response) {
                        if (response == 1)
                        {
                            $('#messageBoxWarning').hide();
                            $('#messageBox').html("Tréningu <b>" + $('#' + trainingID + "-date").html() + " " + $('#' + trainingID + "-time").html() + "</b> bol zmenený popis na: <b>" + value + "</b>");
                            $('#messageBox').show();
                        }

                    }
                });

            };
       

        $("#TrainingsTable").on("change", ".trainingTrainer", function (event) {
            TrainingTrainer($(this));
        });
        
        function TrainingTrainer(element) {
            var trainingID = element.data('training');
            //value z textboxu
            var value = element.prop('value');
            $.ajax({
                url: "ChangeTrainer",
                data: { trainingID: trainingID, trainer: value },
                type: 'POST',
                dataType: "json",
                success: function (response) {
                    if (response == 2) {
                        $('#messageBoxWarning').hide();
                        $('#messageBox').html("Tréningu <b>" + $('#' + trainingID + "-date").html() + " " + $('#' + trainingID + "-time").html() + "</b> bol priradený nový tréner: <b>" + value + "</b>");
                        $('#messageBox').show();
                    }

                }
            });

        };

        $("#TrainingsTable").on("change", ".trainingCapacity", function (event) {
            TrainingCapacity($(this));
            $("#TrainingsTable").sortOrder

        });

        function TrainingCapacity(element) {
            var trainingID = element.data('training');
                //value z textboxu
            var value = element.prop('value');
                $.ajax({
                    url: "ChangeTrainingCapacity",
                    data: { trainingID: trainingID, capacity: value },
                    type: 'POST',
                    dataType: "json",
                    success: function (response) {
                        if (response == 3) {
                            $('#messageBoxWarning').hide();
                            $('#messageBox').html("Kapacita tréningu <b>" + $('#' + trainingID + "-date").html() + " " + $('#' + trainingID + "-time").html() + "</b> bola zmenená na: <b>" + value + "</b>");
                            $('#messageBox').show();
                        }
                        else if(response == 4)
                        {
                            $('#messageBox').hide();
                            $('#messageBoxWarning').html("Kapacita tréningu nemôže byť menšia ako 1!");
                            $('#messageBoxWarning').show();
                        }
                        else if (response == 13) {
                            $('#messageBox').hide();
                            $('#messageBoxWarning').html("Kapacita tréningu nemôže byť menšia ako počet prihlásených cvičiacich!");
                            $('#messageBoxWarning').show();
                        }

                        }
                });
            }
       

        $("#TrainingsTable").on("click", ".TrainingDetails", function (event) {
            TrainingDetails($(this));
        });

        function TrainingDetails (element) {

                var trainingID = element.data('training');
                $.ajax({
                    //controller method
                    url: "TrainingDetails",
                    //controller method parameter : trainingID
                    data: { trainingID: trainingID },
                    type: 'POST',
                    dataType: "html",
                    success: function (response) {
                        $('#TrainingDetailsBody').html(response);
                        $('#modalTitleTraining').html($('#' + trainingID + "-date").html() + " " + $('#' + trainingID + "-time").html());
                        $('#trainingDetailsModal').modal('show');
                    }
                });
        }

        $("#TrainingsTable").on("click", ".CancelTraining", function (event) {
            CancelTraining($(this));
        });

        function CancelTraining(changedElement) {
                var trainingID = changedElement.data('training');
                $.ajax({
                    //controller method
                    url: "CancelTraining",
                    //controller method parameter : trainingID
                    data: { trainingID: trainingID },
                    type: 'POST',
                    dataType: "json",
                    success: function (response) {
                        if (response == 10) {
                            $('#messageBoxWarning').html("Tréning <b>" + $('#' + trainingID + "-date").html() + " " + $('#' + trainingID + "-time").html() + "</b> bol zrušený!");
                            $('#' + trainingID + '-Row').remove();
                            $('#messageBoxWarning').show();
                        }
                    }
                })
            }

        $(function () {
            $('#AddNewTraining').click(function () {

                $('#NewTraining').modal('show');

            });
        });

        $("#NewTraining").keyup(function (event) {
            if (event.target.id != "NewTrainingDescription" && event.keyCode == 13) {
                $("#CreateTrainingButton").click();
            }
        });

        $('#CreateTrainingButton').click(function () {
            var date = $('#TrainingDate').prop('value');
            var time = $('#TrainingTime').prop('value');
            var trainer = $('#NewTrainingTrainer').prop('value');
            var description = $('#NewTrainingDescription').val();
            var capacity = $('#NewTrainingCapacity').val();
            if (capacity == null || capacity =="")
            {
                capacity = -1;
            }
            $.ajax({
                //controller method
                url: "CreateNewTraining",
                //controller method parameter : trainingID
                data: { date: date , time : time, trainer: trainer, description: description,capacity :capacity },
                type: 'POST',
                dataType: "json",
                success: function (response) {
                    switch (response) {
                        case 12:
                            $('#messageBoxNewTraining').html("Nie je možné vytvoriť tréning v minulosti!");
                            $('#messageBoxNewTraining').show();
                            return;
                        case 5:
                            $('#messageBoxNewTraining').html("Je potrebné zadať aj trénera!");
                            $('#messageBoxNewTraining').show();
                            return;
                        case 6:
                            $('#messageBoxNewTraining').html("Je potrebné zadať aj popis tréningu!");
                            $('#messageBoxNewTraining').show();
                            return;
                        case 7:
                            $('#messageBoxNewTraining').html("Dátum je nesprávny!");
                            $('#messageBoxNewTraining').show();
                            return;
                        case 8:
                            $('#messageBoxNewTraining').html("Čas je nesprávny!");
                            $('#messageBoxNewTraining').show();
                            return;
                        case 4:
                            $('#messageBoxNewTraining').html("Kapacita tréningu nemôže byť menej ako 1!");
                            $('#messageBoxNewTraining').show();
                            return;
                        default:
                            $('#NewTraining').modal('hide');

                            var newRow = '<tr id="'+response.TrainingID + '-Row">' +
                              '<td id="' + response.TrainingID + '-date">' + response.Date + '</td>' +
                              '<td id="' + response.TrainingID + '-time">' + response.Time + '</td>' +
                              '<td><textarea  class="trainingDescription form-control input-sm" rows="1" data-training="' + response.TrainingID + '">' + response.Description + '</textarea></td>' +
                              '<td><input type="text" value="' + response.Trainer + '" class="trainingTrainer form-control input-sm" data-training="' + response.TrainingID + '"/></td>' +
                              '<td>' +
                              '<span id="' + response.TrainingID + '-RegisteredNumber">0</span> ' +
                              '<span class="label label-info TrainingDetails" style="cursor:pointer" data-training="' + response.TrainingID + '">Detail</span>' +
                              '</td>' +
                              '<td><input type="number" min="1" value="' + response.Capacity + '" class="trainingCapacity form-control input-sm "data-training="' + response.TrainingID + '"/></td>' +
                              '<td><a class="CancelTraining" data-training="' + response.TrainingID + '" href="#">Zrušiť tréning</a></td>' +
                              '</tr>';

                            $('#TrainingsTable').prepend(newRow);
                            $("#messageBox").html("Nový tréning <b>" + response.Date + " " + response.Time + "</b> bol vytvorený!");
                            $("#messageBox").show();
                    }
                }
            });
        });


        $(function () {
            $("#TrainingDate").datepicker({
                beforeShow: function () {
                    setTimeout(function () {
                        $('.ui-datepicker').css('z-index', 99999999999999);
                    }, 0);
                },
                dateFormat: "dd.mm.yy",
                minDate: 0,
                constrainInput: true,
                monthNames: ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"],
                monthNamesShort: ["Jan", "Feb", "Mar", "Apr", "Máj", "Jún", "Júl", "Aug", "Sep", "Okt", "Nov", "Dec"],
                dayNames: ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"],
                dayNamesMin: ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"],
                firstDay: 1
            });
        });


        $('#TrainingTime').timepicker(
            {
                showPeriodLabels: false,
                showOn: 'both',
                button: '#trainingTimeButton',
                hourText: 'Hodiny',
                minuteText: 'Minúty',
                minutes: {
                    interval: 15
                }
            }
          );


    </script>
    }
