@using Speranza.Models
@using Speranza.Views
@model Speranza.Models.AdminUsersModel
@{
    ViewBag.Title = "Správa používateľov";
    Layout = "~/Views/Layout.cshtml";
}

<div class="container">
    <h2>Správa používateľov</h2>



    <div id="messageBox" style="display:none;" class="alert alert-success" role="alert"></div>


    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Meno</th>
                <th>Priezvisko</th>
                <th>Email</th>
                <th>Tel. číslo</th>
                <th>Kategória</th>
                <th>Stav permanentky</th>
                <th>Tréningy</th>
                <th>Admin</th>
            </tr>
        </thead>
        @foreach (var user in Model.Users)
        {
            <tr>
                <td>@user.Name</td>
                <td>@user.Surname</td>
                <td>@user.Email</td>
                <td>@user.PhoneNumber</td>
                <td>
                    @Html.DropDownList("CategoryCombo", ViewHelper.CreateSelectListItems(Model.Categories, user.Category), new { id = user.Email, @class = "Category" })
                </td>
                <td>
                    <span id="freeSignUpsCell-@user.Email"> @user.NumberOfFreeSignUps </span>
                    <div class="btn-group btn-group-xs col-lg-offset-1">
                        <button type="button" class="btn btn-primary SignUpCount" data-count="1" data-email="@user.Email"> +1</button>
                        <button type="button" class="btn btn-primary SignUpCount" data-count="10" data-email="@user.Email">+10</button>
                        <button type="button" class="btn btn-primary SignUpCount" data-count="20" data-email="@user.Email">+20</button>
                        <button type="button" class="btn btn-danger  SignUpCount" data-count="-1" data-email="@user.Email"> -1</button>
                        <button type="button" class="btn btn-danger  SignUpCount" data-count="-10" data-email="@user.Email">-10</button>
                        <button type="button" class="btn btn-danger  SignUpCount" data-count="-20" data-email="@user.Email">-20</button>
                    </div>
                </td>
                <td>
                    <span>@user.TrainingCount</span>
                    <span class="label label-info trainingsDetails" data-email="@user.Email">Detail</span>
                </td>
                <td>@Html.CheckBox("IsAdmin", user.IsAdmin, new { id = user.Email, @class = "IsAdmin" }) </td>
            </tr>
        }
    </table>
</div>

@section scripts {
    <script>
        $(function () {
            $('.IsAdmin').change(function () {

                var self = $(this);
                var id = self.attr('id');
                var value = self.prop('checked');
                $.ajax({
                    url: "ToggleAdmin",
                    data: { id: id, isAdmin: value },
                    type: 'POST',
                    dataType: "json",
                    success: function (response) {
                        if (response.Message == 1)
                            $('#messageBox').html("<b>Zrušenie</b> administrátorských práv pre používateľa: <b>" + response.Email + "</b>");
                        else if (response.Message == 2)
                            $('#messageBox').html("<b>Pridanie</b> administrátorských práv pre používateľa: <b>" + response.Email + "</b>");

                        $('#messageBox').show();
                    }
                });

            });
        });

        $(function () {
            $('.Category').change(function () {

                var self = $(this);
                var id = self.attr('id');
                var value = self.val();
                $.ajax({
                    url: "UserCategory",
                    data: { id: id, category: value },
                    type: 'POST',
                    dataType: "json",
                    success: function (response) {
                        if (response.Message == 3)
                            $('#messageBox').html("Kategória pre používateľa <b>" + response.Email + "</b> bola zmenená na: <b>" + response.Category + "</b>");
                        $('#messageBox').show();
                    }
                });

            });
        });

        $(function () {
            $('.SignUpCount').click(function () {
                var self = $(this);
                var count = self.data("count");
                var email = self.data("email");
                $.ajax({
                    url: "UpdateSignUpCount",
                    data: { id: email, countUpdate: count },
                    type: 'POST',
                    dataType: "json",
                    success: function (response) {
                        if (response.Message == 4)
                            $('#messageBox').html("Počet vstupov užívateľovi <b>" + response.Email + "</b> bol zvýšený o <b>" + response.ChangeNumberOfSignUps + "</b>");
                        else if (response.Message == 5) {
                            var changedCount = response.ChangeNumberOfSignUps;
                            if ($('#freeSignUpsCell-' + response.Email).text() < response.ChangeNumberOfSignUps) {
                                changedCount = $('#freeSignUpsCell-' + response.Email).text();
                            }
                            $('#messageBox').html("Počet vstupov užívateľovi <b>" + response.Email + "</b> bol znížený o <b>" + changedCount + "</b>");

                        }

                        $('#messageBox').show();
                        $('#freeSignUpsCell-' + response.Email).text(response.AfterChangeNumberOfSignUps);
                    }
                });

            });
        });


        $(function () {
            $('.trainingsDetails').click(function () {
                var self = $(this);
                var email = self.data("email");
                $.ajax({
                    url: "TrainingsDetails",
                    data: { id: email },
                    type: 'POST',
                    dataType: "json",
                    success: function (response) {

                    }

                });

            });
        });
    </script>
}